<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ポケモン色違い厳選カウンター</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  text-align:center;
  background:#f5f7fa;
  margin:0;
  padding:20px;
}

.card{
  background:#fff;
  padding:15px;
  margin:auto;
  max-width:520px;
  border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,.1);
}

button{
  font-size:18px;
  padding:10px 14px;
  margin:4px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

.primary{background:#4CAF50;color:#fff;}
.danger{background:#f44336;color:#fff;}
.gold{background:gold;}
.small{font-size:14px;padding:6px 10px;}

.item{
  display:flex;
  align-items:center;
  background:#fafafa;
  border:1px solid #ddd;
  border-radius:8px;
  margin-bottom:8px;
  padding:10px;
}

.handle{
  font-size:22px;
  padding:6px 12px;
  background:#eee;
  margin-right:8px;
  border-radius:6px;
  touch-action:none;
}

.nameArea{
  text-align:left;
  flex:1;
}

.dragging{
  opacity:.4;
}
</style>
</head>

<body>

<h1>ポケモン色違い厳選カウンター</h1>
<div id="app"></div>

<script>
let saved = JSON.parse(localStorage.getItem("shinyData") || "{}");

let data  = saved.data  || {};
let order = saved.order || Object.keys(data);

function save(){
  localStorage.setItem("shinyData",
    JSON.stringify({data,order})
  );
}

/* ===== 一覧 ===== */

function renderList(){

  let html = `
  <div class="card">
    <h2>ポケモン一覧（≡ を長押しして移動）</h2>
  `;

  order.forEach(name=>{
    if(!data[name]) return;

    html+=`
    <div class="item" data-name="${name}">
      <div class="handle">≡</div>

      <div class="nameArea">
        <b>${name}</b>（${data[name].count}回）<br>
        <button class="small primary"
                onclick="openCounter('${name}')">開く</button>
        <button class="small danger"
                onclick="deletePokemon('${name}')">削除</button>
      </div>
    </div>`;
  });

  html+=`
    <button class="primary" onclick="addPokemon()">＋ 新しいポケモン</button>
  </div>`;

  document.getElementById("app").innerHTML = html;

  enableTouchDrag();
}

/* ===== タッチ並び替え ===== */

function enableTouchDrag(){

  const handles = document.querySelectorAll(".handle");

  handles.forEach(handle=>{

    handle.addEventListener("touchstart", startDrag);
    handle.addEventListener("mousedown", startDrag);

  });
}

let draggedItem = null;

function startDrag(e){

  e.preventDefault();

  draggedItem = this.parentElement;
  draggedItem.classList.add("dragging");

  document.addEventListener("touchmove", onMove);
  document.addEventListener("mousemove", onMove);

  document.addEventListener("touchend", endDrag);
  document.addEventListener("mouseup", endDrag);
}

function onMove(e){

  if(!draggedItem) return;

  let y = e.touches ? e.touches[0].clientY : e.clientY;

  const items = [...document.querySelectorAll(".item")];

  for(let item of items){

    const rect = item.getBoundingClientRect();
    const mid = rect.top + rect.height / 2;

    if(y < mid){
      item.parentNode.insertBefore(draggedItem, item);
      break;
    }
  }
}

function endDrag(){

  if(!draggedItem) return;

  draggedItem.classList.remove("dragging");

  const items = document.querySelectorAll(".item");
  order = [...items].map(i => i.dataset.name);

  save();

  draggedItem = null;

  document.removeEventListener("touchmove", onMove);
  document.removeEventListener("mousemove", onMove);
  document.removeEventListener("touchend", endDrag);
  document.removeEventListener("mouseup", endDrag);
}

/* ===== 追加・削除 ===== */

function addPokemon(){
  const name = prompt("ポケモン名を入力");
  if(!name) return;

  if(data[name]){
    alert("既に登録されています");
    return;
  }

  data[name] = {count:0};
  order.push(name);

  save();
  renderList();
}

function deletePokemon(name){
  if(!confirm(name+" を削除しますか？")) return;

  delete data[name];
  order = order.filter(n=>n!==name);

  save();
  renderList();
}

/* ===== カウンター ===== */

function openCounter(name){
  document.getElementById("app").innerHTML = `
  <div class="card">
    <h2>${name}</h2>
    <h1 id="count">${data[name].count}</h1>

    <button class="primary" onclick="inc('${name}')">+1</button>
    <button onclick="dec('${name}')">-1</button>
    <button onclick="reset('${name}')">リセット</button>

    <br><br>
    <button class="gold" onclick="shiny('${name}')">
      ✨ 色違い出現！
    </button>
    <br><br>
    <button onclick="renderList()">← 一覧へ戻る</button>
  </div>`;
}

function update(n){
  document.getElementById("count").innerText = data[n].count;
  save();
}

function inc(n){data[n].count++;update(n);}
function dec(n){data[n].count=Math.max(0,data[n].count-1);update(n);}
function reset(n){data[n].count=0;update(n);}

function shiny(name){
  alert(name+" の色違いが "+data[name].count+" 回目で出現！");
  data[name].count=0;
  update(name);
}

renderList();
</script>

</body>
</html>
